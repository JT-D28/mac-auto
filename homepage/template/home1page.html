{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>首页</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="{% static 'homepage/layui/css/layui.css' %}" media="all">
    <link rel="stylesheet" href="{% static 'homepage/layui/css/layuimini.css' %}" media="all">
    <link rel="stylesheet" href="{% static 'homepage/public.css' %}" media="all">
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="{% static 'homepage/vue.js' %}"></script>
    <script src="{% static 'homepage/eleui/index.js' %}"></script>
    <script src="https://gw.alipayobjects.com/os/lib/antv/g2plot/0.11.3/dist/g2plot.js"></script>
    <style>
        .layui-card {
            border: 1px solid #f2f2f2;
            border-radius: 5px;
        }

        .el-tabs__item {
            padding: 0 15px;
        }

        .el-dialog__body {
            padding-top: 0;
            padding-bottom: 10px;
        }

        .el-card__header {
            padding: 6px 20px;
        }

        .layui-card>.el-tabs--left .el-tabs__header.is-left {
            margin-right: 0;
        }

        .jacocofontsize {
            font-size: 12px;
            padding-left: 5px;
        }

        #coverage > .el-card__body {
            padding: 0px !important;
        }

        #echarts-records :first-child {
            margin: 0 auto !important;
        }

        .workbtn-module {
            text-align: center;
            margin: 15px 0;
            height: 100%;
            border-right: 2px solid rgba(248, 248, 248, 1);
        }

        .layui-tab-title > span {
            display: none;
        }

        .layui-tab-title li {
            min-width: 0;
            padding: 0;
            font-size: 12px;
        }

        .workbtn-module a i {
            display: inline-block;
            width: 100%;
            height: 60px;
            line-height: 60px;
            text-align: center;
            border-radius: 2px;
            font-size: 30px;
            background-color: rgba(0, 0, 0, 0);
            color: #333;
            transition: all .3s;
            -webkit-transition: all .3s;
        }

        .workbtn-module a cite {
            position: relative;
            top: 2px;
            display: block;
            color: #666;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            font-size: 14px;
        }

        .work-module {
            width: 100%;
        }

        #planHistory > .el-dialog {
            height: 94%;
        }

        #productSet > .el-dialog {
            height: 80%;
        }
    </style>
</head>

<style>
    .layui-tab-title {
        border-bottom: none;
    }

    /* 重置 - 去掉下划线 */
    .layui-tab-title .layui-this {
        background: #81ffd9;
    }

    /* 增加背景 */
    .layui-tab-title .layui-this:after {
        border: none;
    }

    /* 重置 -this无边框 */
    .layui-tab-title li {
        display: list-item;
    }

    /* 重置 -纵向显示 */
    .demo-table-expand {
        font-size: 0;
    }

    .demo-table-expand label {
        width: 90px;
        color: #99a9bf;
    }

    .demo-table-expand .el-form-item {
        margin-right: 0;
        margin-bottom: 0;
        width: 50%;
    }

    .div-outer {
        height: 100%;
        box-sizing: border-box;
        padding-top: 100px;
    }

    .div-top {
        background-color: burlywood;
    }

    .div-content {
        background-color: #8ddad3;
        height: 100%;
    }

</style>
<script src="{% static 'manager/js/utils.js' %}" charset="utf-8"></script>


<body>


<div id='app'>

    <el-form :inline="true" :model="form" style="margin-bottom: 15px" class="demo-form-inline">
        <el-select v-model="form.product" filterable placeholder="选择项目" style="width: 240px;padding-right: 15px"
                   @change="selectProduct">
            <el-option v-for="product in products" :key="product.id"
                       :label="product.description"
                       :value="product.id">
            </el-option>
        </el-select>
        <el-select v-model="form.plan" @visible-change="selectPlanVisible($event)" filterable
                   placeholder="选择计划" style="width: 240px">
            <el-option v-for="plan in plans" :key="plan.id" :label="plan.name"
                       :value="plan.id">
            </el-option>
        </el-select>
    </el-form>
    <div class="layui-row" style="margin-bottom: 15px">
        <div class="layui-col-xs12 layui-col-md12">
            <div class="layui-card">
                <div class="work-module">
                    <div class="layui-row">
                        <div class="layui-col-xs4 layui-col-md2 workbtn-module" style="">
                            <a @click="runplan" href="javascript:;" title="这里是验证用例，调试去用例管理！">
                                <i class="layui-icon layui-icon-play"></i>
                                <cite>验证</cite>
                            </a>
                        </div>
                        <div class="layui-col-xs4 layui-col-md2 workbtn-module">
                            <a @click="setplan" href="javascript:;">
                                <i class="layui-icon layui-icon-set"></i>
                                <cite>项目设置</cite>
                            </a>
                        </div>
                        <div class="layui-col-xs4 layui-col-md2 workbtn-module">
                            <a @click="planHistory" href="javascript:;">
                                <i class="layui-icon layui-icon-survey"></i>
                                <cite>历史记录</cite>
                            </a>
                        </div>
                        <div class="layui-col-xs4 layui-col-md2 workbtn-module">
                            <a @click="newRepoet" @contextmenu.prevent="downloadReport" href="javascript:;">
                                <i class="layui-icon layui-icon-chart-screen"></i>
                                <cite>最新报告</cite>
                            </a>
                        </div>
                        <div class="layui-col-xs4 layui-col-md2 workbtn-module">
                            <a @click="setPlanNotice" href="javascript:;">
                                <i class="layui-icon layui-icon-notice"></i>
                                <cite>报告通知</cite>
                            </a>
                        </div>
                        <div class="layui-col-xs4 layui-col-md2 workbtn-module">
                            <a @click="seeprocess" @contextmenu.prevent="downloadRunlog"
                               href="javascript:;">
                                <i class="layui-icon layui-icon-log"></i>
                                <cite>运行日志</cite>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="layui-row" style="display:flex;bottom: 0">
        <div class="layui-card" style="width:25%;height:100%;margin-bottom:0;margin-right: 15px;height: 365px;display: inline-block">
            <div style="padding:15px">
                <div>
                    <p style="font-size:14px;font-family:PingFang-SC-Medium,PingFang-SC;font-weight:500;line-height:20px;">
                        项目运行情况</p>
                </div>
                <div style="margin-top: 45px">
                    <div style="padding: 0 0 0 6%;height: 100px">
                        <div class="layui-row">
                            <div id="productCount" class="layui-col-md4"
                                 style="width: 100px;height: 100px"></div>
                            <div class="layui-col-md6 " v-html="productCountnum" style="margin: 10% 0 0 5%;"></div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 45px">
                    <div style="padding: 0 0 0 6%;height: 100px">
                        <div class="layui-row">
                            <div id="productRate" class="layui-col-md4"
                                 style="width: 100px;height: 100px"></div>
                            <div class="layui-col-md6 " v-html="productRatenum" style="margin: 10% 0 0 5%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-card" style="flex:1;width:100%;height:365px;display: inline-block">
            <el-tabs @tab-click="reportChartCilck" :tab-position="productsetposition">
                <el-tab-pane label="计划成功率">
                    <div id="echarts-records"
                         style="background-color:#f2f2f2;min-height:365px;"></div>
                </el-tab-pane>
                <el-tab-pane label="代码覆盖率">
                    <el-card id="coverage" class="box-card">
                        <div slot="header" class="clearfix">
                            <el-select @change="serviceChange" clearable collapse-tags filterable
                                       v-model="form.service" multiple style="width: 50%">
                                <el-option
                                        v-for="i in services"
                                        :key="i.id"
                                        :label="i.name"
                                        :value="i.id">
                                </el-option>
                            </el-select>
                            <el-button type="success" @click="jacocoReFlash">${synchronize}</el-button>
                            <el-button type="success" @click="jacocoRun">${jacocoRunstate}</el-button>
                        </div>
                        <div class="text item">
                            <div class="layui-col-md4">
                                <div class="layui-card">
                                    <div class="layui-card-header">
                                        branchCoverage
                                    </div>
                                    <div class="layui-card-body" style="padding:5px 15px">
                                        <div class="layui-row">
                                            <div id="branchCoverage" class="layui-col-md4"
                                                 style="width: 100px;height: 100px"></div>
                                            <div class="layui-col-md6 jacocofontsize">
                                                覆盖率：${Coverage.branchCoverage.percentageFloat}%<br>
                                                覆盖数：${Coverage.branchCoverage.covered}<br>
                                                缺失数：${Coverage.branchCoverage.missed}<br>
                                                总 数：${Coverage.branchCoverage.total}<br>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md4">
                                <div class="layui-card">
                                    <div class="layui-card-header">
                                        classCoverage
                                    </div>
                                    <div class="layui-card-body" style="padding:5px 15px">
                                        <div class="layui-row">
                                            <div id="classCoverage" class="layui-col-md4"
                                                 style="width: 100px;height: 100px"></div>
                                            <div class="layui-col-md6 jacocofontsize">
                                                覆盖率：${Coverage.classCoverage.percentageFloat}%<br>
                                                覆盖数：${Coverage.classCoverage.covered}<br>
                                                缺失数：${Coverage.classCoverage.missed}<br>
                                                总 数：${Coverage.classCoverage.total}<br>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md4">
                                <div class="layui-card">
                                    <div class="layui-card-header">
                                        instructionCoverage
                                    </div>
                                    <div class="layui-card-body" style="padding:5px 15px">
                                        <div class="layui-row">
                                            <div id="instructionCoverage" class="layui-col-md4"
                                                 style="width: 100px;height: 100px"></div>
                                            <div class="layui-col-md6 jacocofontsize">
                                                覆盖率：${Coverage.instructionCoverage.percentageFloat}%<br>
                                                覆盖数：${Coverage.instructionCoverage.covered}<br>
                                                缺失数：${Coverage.instructionCoverage.missed}<br>
                                                总 数：${Coverage.instructionCoverage.total}<br>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md4">
                                <div class="layui-card">
                                    <div class="layui-card-header">
                                        complexityScore
                                    </div>
                                    <div class="layui-card-body" style="padding:5px 15px">
                                        <div class="layui-row">
                                            <div id="complexityScore" class="layui-col-md4"
                                                 style="width: 100px;height: 100px"></div>
                                            <div class="layui-col-md6 jacocofontsize">
                                                覆盖率：${Coverage.complexityScore.percentageFloat}%<br>
                                                覆盖数：${Coverage.complexityScore.covered}<br>
                                                缺失数：${Coverage.complexityScore.missed}<br>
                                                总 数：${Coverage.complexityScore.total}<br>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md4">
                                <div class="layui-card">
                                    <div class="layui-card-header">
                                        lineCoverage
                                    </div>
                                    <div class="layui-card-body" style="padding:5px 15px">
                                        <div class="layui-row">
                                            <div id="lineCoverage" class="layui-col-md4"
                                                 style="width: 100px;height: 100px"></div>
                                            <div class="layui-col-md6 jacocofontsize">
                                                覆盖率：${Coverage.lineCoverage.percentageFloat}%<br>
                                                覆盖数：${Coverage.lineCoverage.covered}<br>
                                                缺失数：${Coverage.lineCoverage.missed}<br>
                                                总 数：${Coverage.lineCoverage.total}<br>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md4">
                                <div class="layui-card">
                                    <div class="layui-card-header">
                                        methodCoverage
                                    </div>
                                    <div class="layui-card-body" style="padding:5px 15px">
                                        <div class="layui-row">
                                            <div id="methodCoverage" class="layui-col-md4"
                                                 style="width: 100px;height: 100px"></div>
                                            <div class="layui-col-md6 jacocofontsize">
                                                覆盖率：${Coverage.methodCoverage.percentageFloat}%<br>
                                                覆盖数：${Coverage.methodCoverage.covered}<br>
                                                缺失数：${Coverage.methodCoverage.missed}<br>
                                                总 数：${Coverage.methodCoverage.total}<br>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </el-card>
                </el-tab-pane>
            </el-tabs>
        </div>

    </div>

    <el-dialog id='productSet' title='项目设置' :visible.sync="productSetVisible" width="70%" top="3vh"
               style="height: 100%">
        <el-tabs :tab-position="productsetposition">
            <el-tab-pane label="jacoco配置">
                <el-form :label-position="productsetposition" label-width="15%" :model="form">
                    <el-form-item label="jenkins地址">
                        <el-input v-model="form.productset.jenkinsurl"></el-input>
                    </el-form-item>
                    <el-form :inline="true" :model="form" class="demo-form-inline">
                        <el-form-item label="用户名" style="width: 47%" label-width="32%">
                            <el-input v-model="form.productset.authname"></el-input>
                        </el-form-item>
                        <el-form-item label="密码" style="width: 47%" label-width="32%">
                            <el-input v-model="form.productset.authpwd"></el-input>
                        </el-form-item>
                    </el-form>
                    <el-form-item label="服务名和任务名">
                        <el-input type="textarea" v-model="form.productset.jobname" placeholder='填入内容为描述/服务名称和jenkins中对应的任务名，格式示例：
settlesys:tfp-cmbc-mysql-uat-settlesys;thirdsys:tfp-cmbc-mysql-uat-thirdsys'></el-input>
                    </el-form-item>
                </el-form>
                <el-button type="primary" @click="jacocoSetSave">保存</el-button>
                <el-button @click="productSetVisible = false">取消</el-button>
            </el-tab-pane>
            <el-tab-pane label='解除运行状态'>
                <el-form :inline="true" :model="form" class="demo-form-inline">
                    <el-select v-model="form.forceStopPlans" filterable placeholder="选择计划"
                               style="width: 49%">
                        <el-option v-for="plan in plans" :key="plan.id" :label="plan.name"
                                   :value="plan.id">
                        </el-option>
                    </el-select>
                    <h3 style="margin-top: 3rem">任务当前状态：${runningState}</h3><br>
                </el-form>
                <el-button type="success" @click="planStatereFlash" style="margin-top: 2rem">刷新
                </el-button>
                <el-tooltip class="item" effect="dark" content="确定计划运行完成但是提示还在运行时点击" placement="bottom">
                    <el-button type="danger" @click="forceStop" style="margin-top: 2rem">更改运行状态
                    </el-button>
                </el-tooltip>
            </el-tab-pane>
            <el-tab-pane label='外部调用链接'>
                <el-select v-model="form.third_plan" filterable placeholder="选择计划" style="width: 49%">
                    <el-option v-for="plan in plans" :key="plan.id" :label="plan.name"
                               :value="plan.id">
                    </el-option>
                </el-select>

                <div style="margin-top: 15px;">
                    <el-input placeholder="验证地址" v-model="form.is_verify_url">
                        <template slot="prepend">验证地址</template>
                        <template slot="append">
                            <el-button type="primary" icon="el-icon-copy-document" plain
                                       @click="copyUrl(form.is_verify_url)"></el-button>
                        </template>
                    </el-input>
                </div>
                <div style="margin-top: 15px;">
                    <el-input placeholder="调试地址" v-model="form.debug_url">
                        <template slot="prepend">调试地址</template>
                        <template slot="append">
                            <el-button type="primary" icon="el-icon-copy-document" plain
                                       @click="copyUrl(form.debug_url)"></el-button>
                        </template>
                    </el-input>
                </div>
            </el-tab-pane>
        </el-tabs>
    </el-dialog>
    <el-dialog title="通知配置" :visible.sync="noticeSetVisible" width="70%" top="3vh" style="height: 100%">
        <el-form :model="form">
            <el-form-item label="配色方案" :label-width="form.formLabelWidth">
                <el-select v-model="form.reportNoticeSet.color" placeholder="请选择配色方案">
                    <el-option label="red" value="red"></el-option>
                    <el-option label="blue" value="blue"></el-option>
                </el-select>
            </el-form-item>
            <el-tooltip class="item" effect="dark" content="多收件人请用,分隔" placement="bottom">
                <el-form-item label="收件人" :label-width="form.formLabelWidth">
                    <el-input v-model="form.reportNoticeSet.to_receive" autocomplete="off"></el-input>
                </el-form-item>
            </el-tooltip>
            <el-form-item label="标题" :label-width="form.formLabelWidth">
                <el-input v-model="form.reportNoticeSet.description" autocomplete="off"></el-input>
            </el-form-item>
            <el-tooltip class="item" effect="dark" content="内容中如果有参数，只会在任务运行完成后替换，手动发送报告不生效"
                        placement="bottom">
                <el-form-item label="邮件内容" :label-width="form.formLabelWidth">
                    <el-input type="textarea" v-model="form.reportNoticeSet.text"
                              autocomplete="off"></el-input>
                </el-form-item>
            </el-tooltip>
            <el-form-item label="钉钉机器人token" :label-width="form.formLabelWidth"
                          style="margin-top: 2rem">
                <el-input v-model="form.reportNoticeSet.dingdingtoken" autocomplete="off"></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button type="success" round @click="sendRepoet">发送最新报告</el-button>
            <el-button type="primary" @click="savenoticeSet(0)">保 存</el-button>
            <el-button @click="noticeSetVisible = false">关 闭</el-button>
        </div>
    </el-dialog>
    <el-dialog id="planHistory" title='历史记录' :visible.sync="planHistoryVisible" width="90%" top="3vh"
               style="height: 100%">
        <el-tabs :tab-position="productsetposition" style="min-height: 320px;">
            <el-tab-pane label="历史缺陷">
                <el-date-picker
                        v-model="historytime"
                        type="daterange"
                        align="right"
                        @change="queryOldBug('omit')"
                        unlink-panels
                        range-separator=" - "
                        value-format="yyyy-MM-dd"
                        start-placeholder="开始日期"
                        end-placeholder="结束日期"
                        :picker-options="pickerOptions">
                </el-date-picker>
                <table id="oldbugtable" lay-size='sm' lay-filter="oldbugtable"
                       style="height: 100%"></table>
            </el-tab-pane>
        </el-tabs>
    </el-dialog>
    <div id="seeprocess" hidden>
        <div class="layui-table">
            <div class="layui-card-body">
                <div id="log_text"></div>
            </div>
        </div>
    </div>
</div>


<script src="{% static 'homepage/echarts.common.min.js' %}" charset="utf-8"></script>
<script src="{% static 'homepage/echartsTheme.js' %}" charset="utf-8"></script>
<script src="{% static 'homepage/layui/layui.js' %}" charset="utf-8"></script>
<script src="{% static 'manager/js/jquery.min.js' %}"></script>
<script>
    var app = new Vue({
        el: '#app',
        delimiters: ['${', '}'],
        data() {
            var vue = this;
            return {
                productCountnum: '',
                productRatenum: '',
                noticeSetVisible: false,
                runningState: '',
                log_text: '',
                synchronize: '获取',
                Coverage: {
                    branchCoverage: {
                        "covered": 0,
                        "missed": 0,
                        "percentageFloat": 0,
                        "total": 0
                    },
                    classCoverage: {
                        "covered": 0,
                        "missed": 0,
                        "percentageFloat": 0,
                        "total": 0
                    },
                    complexityScore: {
                        "covered": 0,
                        "missed": 0,
                        "percentageFloat": 0,
                        "total": 0
                    },
                    instructionCoverage: {
                        "covered": 0,
                        "missed": 0,
                        "percentageFloat": 0,
                        "total": 0
                    },
                    lineCoverage: {
                        "covered": 0,
                        "missed": 0,
                        "percentageFloat": 0,
                        "total": 0
                    },
                    methodCoverage: {
                        "covered": 0,
                        "missed": 0,
                        "percentageFloat": 0,
                        "total": 0
                    }
                },
                historytime: '',
                jacocoRunstate: '运行',
                timeDefaultShow: '',
                pickerOptions: {
                    shortcuts: [{
                        text: '最近3天',
                        onClick(picker) {
                            const end = new Date();
                            const start = new Date();
                            start.setTime(start.getTime() - 3600 * 1000 * 24 * 3);
                            picker.$emit('pick', [start, end]);
                        }
                    }, {
                        text: '最近一周',
                        onClick(picker) {
                            const end = new Date();
                            const start = new Date();
                            start.setTime(start.getTime() - 3600 * 1000 * 24 * 7);
                            picker.$emit('pick', [start, end]);
                        }
                    }, {
                        text: '最近一个月',
                        onClick(picker) {
                            const end = new Date();
                            const start = new Date();
                            start.setTime(start.getTime() - 3600 * 1000 * 24 * 30);
                            picker.$emit('pick', [start, end]);
                        }
                    }, {
                        text: '最近三个月',
                        onClick(picker) {
                            const end = new Date();
                            const start = new Date();
                            start.setTime(start.getTime() - 3600 * 1000 * 24 * 90);
                            picker.$emit('pick', [start, end]);
                        }
                    }],
                    disabledDate(time) {
                        return time.getTime() > Date.now();
                    }, onPick(time) {
                        if (time.minDate && !time.maxDate) {
                            vue.timeOptionRange = time.minDate;
                        }
                        if (time.maxDate) {
                            vue.timeOptionRange = null;
                        }
                    }
                },
                oldBugData: [{
                    路径: '',
                    接口: '',
                    测试点: '',
                    参数信息: '',
                    失败原因: '',
                    任务id: '',
                }],
                mailcolors: [{id: 1, color: 'blue'}, {id: 2, color: 'red'}],
                products: [],
                plans: [],
                services: [],
                runVisible: false,
                productSetVisible: false,
                productsetposition: 'left',
                planHistoryVisible: false,
                form: {
                    debug_url: '',
                    is_verify_url: '',
                    formLabelWidth: '120px',
                    product: '',
                    third_plan: '',
                    forceStopPlans: '',
                    plan: '',
                    service: '',
                    mailcolor: '',
                    productset: {
                        jenkinsurl: '',
                        authname: '',
                        authpwd: '',
                        jobname: '',
                    },
                    reportNoticeSet: {
                        color: '',
                        to_receive: '',
                        description: '',
                        text: '',
                        dingdingtoken: ''
                    }
                },
            }
        },
        methods: {
            getproduct() {
                var that = this;
                _post_nl('/homepage/queryproduct/', {}, function (data) {
                    var data = JSON.parse(data);
                    that.products = data.data
                })
            },
            selectProduct() {
                var that = this;
                this.form.plan = '';
                _post_nl('/homepage/queryplan/', {id: this.form.product}, function (data) {
                    data = JSON.parse(data)
                    that.plans = data.data;
                    that.services = data.service;
                    that.form.plan = that.plans[0] != null ? that.plans[0].id : ''
                    that.form.service = that.services[0] != null ? [that.services[0].id] : []
                    that.getReportChart()
                    that.getproductReport(data.rate, data.total)
                })
            },
            runplan() {
                var that = this;
                planid = that.form.plan.substr(5);
                if (planid != '') {
                    _post_nl('/manager/runplan', {ids: planid, is_verify: '1'}, function (data) {
                        data = JSON.parse(data)
                        if (data.code == 0) {
                            layer.msg(data.msg, {
                                time: 30000,
                                shade: 0.2,
                                shadeClose: true,
                                btn: ['火速围观', '残忍拒绝'],
                                yes: function (index, layero) {
                                    window.top.document.getElementById("console").click()
                                    layer.close(index)
                                }
                            });
                            setTimeout(function () {
                                _post_nl('/homepage/queryPlanState/', {
                                    id: that.form.plan,
                                    refresh: 1
                                }, function (data) {
                                    if (data.data == 1) {
                                        that.getReportChart()
                                    }
                                })
                            }, 2000)
                        } else layer.msg(data.msg)
                    })
                } else {
                    this.$message({
                        message: '请选择项目和计划',
                        type: 'error', center: true
                    });
                }
            },
            setplan() {
                var that = this;
                var productid = that.form.product;
                if (productid == '') {
                    this.$message({
                        message: '请选择项目',
                        type: 'error', center: true
                    });
                } else {
                    _post_nl('/homepage/queryProductSet/', {productid: productid}, function (data) {
                        if (data.code == 0) {
                            that.form.productset.jenkinsurl = data.data.jenkinsurl;
                            that.form.productset.authname = data.data.authname
                            that.form.productset.authpwd = data.data.authpwd
                            that.form.productset.jobname = data.data.jobname
                            that.productSetVisible = true;
                        } else {
                            layer.msg(data.msg)
                        }
                    })
                }
            },
            jacocoSetSave() {
                var that = this;
                var jenkinsurl = that.form.productset.jenkinsurl;
                var authname = that.form.productset.authname;
                var authpwd = that.form.productset.authpwd;
                var jobname = that.form.productset.jobname;
                var productid = that.form.product;
                _post_nl('/homepage/editProductSet/', {
                    productid: productid, jenkinsurl: jenkinsurl,
                    authname: authname, authpwd: authpwd, jobname: jobname
                }, function (data) {
                    if (data.code == 0) {
                        layer.msg(data.msg);
                        that.productSetVisible = false;
                    } else lay.msg(data.msg)
                })
            },
            planHistory() {
                var that = this;
                planid = that.form.plan.substr(5);
                if (planid != '') {
                    const start = new Date().toJSON().substr(0, 10);
                    const end = new Date().toJSON().substr(0, 10);
                    this.historytime = [start, end];
                    this.queryOldBug('omit');
                    this.planHistoryVisible = true
                } else this.$message({
                    message: '请选择项目',
                    type: 'error', center: true
                });
            },
            newRepoet() {
                var that = this;
                planid = that.form.plan.substr(5)
                if (planid == '') {
                    this.$message({
                        message: '请选择项目和计划',
                        type: 'error', center: true
                    });
                } else {
                    _post_nl('/homepage/querytaskid/', {'planid': planid}, function (data) {
                        data = JSON.parse(data)
                        taskid = data.data
                        if (data.code != 0) {
                            layer.msg(data.msg);
                        } else {
                            var resulturl = '/manager/querytaskdetail/?taskid=' + taskid
                            //window.open(resulturl)
                            layer.open({
                                type: 2,
                                title: false,
                                shade: [0],
                                area: ['90%', '90%'],
                                anim: 2,
                                shadeClose: true,
                                content: [resulturl, 'yes'], //iframe的url，no代表不显示滚动条
                            });
                        }
                    })
                }
            },
            setPlanNotice() {
                var that = this;
                var planid = that.form.plan.substr(5);
                if (planid == '') {
                    this.$message({
                        message: '请选择计划',
                        type: 'error', center: true
                    });
                } else {
                    _post_nl('/manager/queryonemailconfig/', {id: planid}, function (data) {
                        if (data.code == 0) {
                            that.form.reportNoticeSet.color = data.data.color_scheme;
                            that.form.reportNoticeSet.to_receive = data.data.to_receive;
                            that.form.reportNoticeSet.description = data.data.description;
                            that.form.reportNoticeSet.text = data.data.rich_text;
                            that.form.reportNoticeSet.dingdingtoken = data.data.dingdingtoken
                            that.noticeSetVisible = true;
                        } else {
                            layer.msg(data.msg)
                        }
                    })
                }
            },
            savenoticeSet(ss) {
                var that = this;
                var planid = that.form.plan.substr(5);
                _post_nl("/manager/editmailconfig/", {
                    id: planid,
                    color_scheme: that.form.reportNoticeSet.color,
                    description: that.form.reportNoticeSet.description,
                    to_receive: that.form.reportNoticeSet.to_receive,
                    rich_text: that.form.reportNoticeSet.text,
                    dingdingtoken: that.form.reportNoticeSet.dingdingtoken,
                }, function (data) {
                    data = JSON.parse(data);
                    if (data.code == 0 && ss == 0) {
                        that.noticeSetVisible = false;
                        layer.msg(data.msg)
                    } else if (data.code == 0 && ss == 1) {
                        return
                    } else layer.alert(data.msg, {icon: 2, time: 2000})
                })
            },
            sendRepoet() {
                var that = this;
                if (that.form.reportNoticeSet.to_receive == undefined) {
                    layer.alert("请检查内容！", {icon: 2, time: 1500})
                }
                that.savenoticeSet(1);
                planid = that.form.plan.substr(5);
                _post_nl('/homepage/sendreport/', {'planid': planid}, function (data) {
                    data = JSON.parse(data)
                    if (data.code == 0) {
                        layer.alert(data.msg, {icon: 1, time: 1500}, area = ['500px', '300px'])
                        that.noticeSetVisible = false;
                    } else {
                        layer.alert(data.msg, {icon: 2, time: 1500})
                    }
                })
            },
            seeprocess() {
                var that = this;
                planid = that.form.plan.substr(5);
                if (planid == '') {
                    this.$message({
                        message: '请选择项目和计划',
                        type: 'error', center: true
                    });
                } else {
                    _post_nl('/homepage/querytaskid/', {planid: planid}, function (data) {
                        data = JSON.parse(data)
                        taskid = data.data
                        is_running = data.is_running
                        if (data.code != 0) {
                            layer.msg(data.msg);
                        } else {
                            var logSocket = new WebSocket("ws://" + host + "/ws/runlog/");
                            layer.open({
                                type: 1,
                                id: "log-process",
                                title: false,
                                shade: [0],
                                area: ['90%', '90%'],
                                anim: 2,
                                shadeClose: true,
                                content: $("#seeprocess"),
                                success: function () {
                                    $("#log_text").html('')
                                    logSocket.onopen = function () {
                                        logSocket.send(is_running + '::' + taskid)
                                    };
                                    logSocket.onmessage = function (e) {
                                        e = JSON.parse(e.data);
                                        setTimeout(() => {
                                            const total = e.count;
                                            const once = is_running === 1 ? 200 : 5000;
                                            const loopCount = total / once;
                                            let countOfRender = 0;
                                            let ul = document.getElementById("log_text");

                                            function add() {
                                                //   console.time('get')
                                                const fragment = document.createDocumentFragment();
                                                // for (let i = 0; i < once; i++) {
                                                //     const li = document.createElement("li");
                                                //      li.innerHTML = e.data[once * countOfRender + i] != undefined ? e.data[once * countOfRender + i] : '';
                                                //       fragment.appendChild(li);
                                                //    }
                                                //   console.timeEnd('get')

                                                const li = document.createElement("li");
                                                li.innerHTML = ArraytoString(e.data.slice(once * countOfRender, once * (countOfRender + 1)));
                                                fragment.appendChild(li);
                                                ul.appendChild(fragment);
                                                countOfRender += 1;
                                                loop();
                                                var exits = document.getElementById('log-process');
                                                if (is_running === '1' && exits != null) {
                                                    exits.scrollTop = exits.scrollHeight;
                                                }
                                            }

                                            function loop() {
                                                if (countOfRender < loopCount) {
                                                    window.requestAnimationFrame(add);
                                                }
                                            }

                                            loop();
                                        }, 100);
                                    };
                                    logSocket.onclose = function () {
                                        console.log("结束获取日志..")
                                    }
                                }, end: function () {
                                    logSocket.close();
                                    $("#log_text").html('')
                                }
                            });
                        }
                    })
                }
            },
            reportconfig(data, code) {
                x = [];
                success = [];
                total = [];
                fail = [];
                skip = [];
                error = [];
                success_rate = []
                hundred = [];
                taskids = [];
                if (code == 0) {
                    title = data[0][1]
                    for (let i = data.length - 1; i >= 0; i--) {
                        x.push(data[i][7])
                        success.push(data[i][2])
                        total.push(data[i][5])
                        fail.push(data[i][3])
                        skip.push(data[i][4])
                        error.push(data[i][9])
                        //mysql  success_rate.push(data[i][8].substr(0, 5))
                        success_rate.push(data[i][8])
                        taskids.push(data[i][6])
                        hundred.push(100 - data[i][8])
                    }
                    totalmax = total.map(function (e) {
                        return Math.max.apply(null, total)
                    });
                } else {
                    title = data
                    totalmax = 1
                }
                var optionRecords = {
                    animation: false,
                    legend: {
                        right: '7%',
                        top: '3%',
                        data: ['成功率', '成功数', '失败数', '错误数', '跳过数', '失败率']
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross'
                        },
                        backgroundColor: 'rgba(245, 245, 245, 0.8)',
                        borderWidth: 1,
                        borderColor: '#ccc',
                        padding: 10,
                        textStyle: {
                            color: '#000'
                        },
                        width: '100px',
                        position: function (pos, params, el, elRect, size) {
                            var obj = {top: 10};
                            obj[['left', 'right'][+(pos[0] < size.viewSize[0] / 2)]] = 30;
                            return obj;
                        },
                        extraCssText: 'width: 100px'
                    },
                    axisPointer: {
                        link: {xAxisIndex: 'all'},
                        label: {
                            backgroundColor: '#777'
                        }
                    },
                    grid: [
                        {
                            top: '20%',
                            left: '10%',
                            right: '10%',
                            height: '68%'
                        },
                    ],
                    xAxis: [
                        {
                            type: 'category',
                            data: x,
                            scale: true,
                            boundaryGap: false,
                            axisLine: {onZero: false},
                            splitLine: {show: false},
                            splitNumber: 20,
                            min: 'dataMin',
                            max: 'dataMax',
                            axisPointer: {
                                z: 100
                            }
                        },
                    ],
                    yAxis: [
                        {
                            scale: true,
                            name: '用例数',
                            min: 0,
                            max: totalmax[0] + 10,
                            position: 'left',
                            offset: 15,
                            splitArea: {
                                show: true
                            },
                            nameTextStyle: {
                                color: 'rgba(153,153,153,1)',
                                fontWeight: 400,
                                fontFamily: 'PingFang-SC-Regular,PingFang-SC',
                                fontSize: 12,
                                lineHeight: 17,
                                padding: [0, 0, 0, -35],
                            }
                        },
                        {
                            scale: true,
                            name: '成功率',
                            position: 'right',
                            splitNumber: 2,
                            axisLabel: {show: true, formatter: '{value}%'},
                            axisLine: {show: true},
                            axisTick: {show: false},
                            splitLine: {show: false},
                            offset: 15,
                            min: 0,
                            max: 100,
                            axisPointer: {
                                label: {
                                    show: false
                                }
                            },
                            nameTextStyle: {
                                color: 'rgba(153,153,153,1)',
                                fontWeight: 400,
                                fontFamily: 'PingFang-SC-Regular,PingFang-SC',
                                fontSize: 12,
                                lineHeight: 17,
                                padding: [0, 0, 0, 44],
                            }
                        },
                    ],

                    series: [
                        {
                            name: '成功数',
                            type: 'line',
                            data: success,
                            symbol: 'none',
                            smooth: true,
                            lineStyle: {
                                normal: {color: 'rgba(0,151,136,1)', width: 3}
                            },
                            itemStyle: {
                                normal: {
                                    color: 'rgba(0,151,136,1)',
                                }
                            },
                        },
                        {
                            name: '失败数',
                            type: 'line',
                            symbol: 'none',
                            data: fail,
                            smooth: true,
                            lineStyle: {
                                normal: {color: 'rgba(105,208,242,1)', width: 3}
                            },
                            itemStyle: {
                                normal: {
                                    color: 'rgba(105,208,242,1)',
                                }
                            },
                        },
                        {
                            name: '跳过数',
                            type: 'line',
                            symbol: 'none',
                            data: skip,
                            smooth: true,
                            lineStyle: {
                                normal: {color: 'rgba(184,223,125,1)', width: 3}
                            },
                            itemStyle: {
                                normal: {
                                    color: 'rgba(184,223,125,1)',
                                }
                            },
                        },
                        {
                            name: '错误数',
                            type: 'line',
                            symbol: 'none',
                            data: error,
                            smooth: true,
                            lineStyle: {
                                normal: {color: 'rgb(255,56,55)', width: 3}
                            },
                            itemStyle: {
                                normal: {
                                    color: 'rgb(255,56,55)',
                                }
                            },
                        },
                        {
                            type: 'bar',
                            axisPointer: {show: false},
                            stack: '总量',
                            yAxisIndex: 1,
                            itemStyle: {
                                normal: {
                                    color: 'rgba(201,155,237,0)',
                                }
                            },
                            data: hundred,
                            barWidth: 30,
                        },
                        {
                            name: '成功率',
                            stack: '总量',
                            type: 'bar',
                            label: {
                                normal: {
                                    show: false,
                                    position: 'top',
                                    color: 'black'
                                }
                            },
                            itemStyle: {
                                normal: {
                                    color: {
                                        type: 'linear',
                                        x: 0,
                                        y: 0,
                                        x2: 0,
                                        y2: 1,
                                        colorStops: [{
                                            offset: 1, color: '#FFFFFFFF' // 0% 处的颜色
                                        }, {
                                            offset: 0, color: '#FFEFEFEF' // 100% 处的颜色
                                        }],
                                        global: false // 缺省为 false
                                    }
                                }
                            },
                            areaStyle: {},
                            yAxisIndex: 1,
                            barWidth: 30,
                            data: success_rate
                        },
                    ]
                };
                $("#echarts-records").css('background-color', 'white')
                return optionRecords;
            },
            jacocoRepConfig(rate) {
                option = {
                    series: [
                        {
                            type: 'pie',
                            radius: ['85%', '95%'],
                            hoverAnimation: false,
                            label: {
                                normal: {
                                    show: true,
                                    position: 'center',
                                    textStyle: {
                                        fontSize: '14',
                                    },
                                },
                            },
                            data: [
                                {value: rate, name: rate + '%'},
                                {value: 100 - rate}
                            ]
                        }
                    ]
                };
                return option
            },
            queryOldBug(taskid) {
                var that = this;
                layui.use('table', function () {
                    layui.table.render({
                        elem: '#oldbugtable',
                        method: 'POST',
                        page: true,
                        limit: 10,
                        height: 'full-170',
                        url: '/homepage/buglog/', //数据接口,
                        where: {
                            time: that.historytime[0] + ';' + that.historytime[1],
                            planid: that.form.plan,
                            taskid: taskid
                        },
                        cols: [[ //表头
                            {field: '路径', title: '用例-步骤', width: "25%", align: "left"}
                            , {field: '接口', title: '接口', width: "40%", align: "left"}
                            , {field: '测试点', title: '测试点', width: "13%", align: "left"}
                            , {field: '参数信息', title: '参数信息', width: "15%", align: "left"}
                            , {field: '失败原因', title: '失败原因', width: "15%", align: "left"}
                            , {field: '任务id', title: '任务id', width: "25%", align: "left"}
                        ]],
                        text: {
                            none: '该期间无缺陷记录！'
                        }
                    });
                })
            },
            downloadReport() {
                var that = this;
                planid = that.form.plan.substr(5);
                if (planid == '') {
                    this.$message({
                        message: '请选择项目和计划',
                        type: 'error', center: true
                    });
                } else {
                    _post_nl('/homepage/querytaskid/', {planid: planid}, function (data) {
                        var res = JSON.parse(data);
                        if (res.code == 0) {
                            const req = new XMLHttpRequest();
                            req.open('POST', '/homepage/downloadReport/', true);
                            req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                            req.responseType = 'blob';
                            req.send("taskid=" + res.data); //输入参数
                            req.onload = function () {
                                console.log(this.response.size)
                                if (this.status === 200 & this.response.size > 20) {
                                    const data = req.response;
                                    const blob = new Blob([data]);
                                    var a = document.createElement('a');
                                    a.download = '报告_' + res.data + '.html';
                                    a.href = window.URL.createObjectURL(blob);
                                    a.click();
                                } else {
                                    layer.msg("没有找到报告记录")
                                }
                            };
                        } else layer.msg(res.msg)
                    })
                }
            },
            downloadRunlog() {
                var that = this;
                _post_nl('/homepage/querytaskid/', {planid: that.form.plan.substr(5)}, function (data) {
                    var res = JSON.parse(data);
                    if (res.code == 0) {
                        const req = new XMLHttpRequest();
                        req.open('POST', '/homepage/downloadlog/', true);
                        req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                        req.responseType = 'blob';
                        req.send("taskid=" + res.data); //输入参数
                        req.onload = function () {
                            console.log(this.response.size)
                            if (this.status === 200 & this.response.size > 20) {
                                const data = req.response;
                                const blob = new Blob([data]);
                                var a = document.createElement('a');
                                a.download = '日志_' + res.data + '.log';
                                a.href = window.URL.createObjectURL(blob);
                                a.click();
                            } else {
                                layer.msg("没有找到运行日志")
                            }
                        };
                    } else layer.msg(res.msg)
                })
            },
            planStatereFlash() {
                var that = this;
                var id = that.form.forceStopPlans
                _post_nl('/homepage/queryPlanState/', {id: id}, function (data) {
                    that.runningState = data.data == 1 ? '运行' : '未运行'
                })
            },
            forceStop() {
                var that = this;
                _post_nl('/homepage/planforceStop/', {id: that.form.forceStopPlans}, function (data) {
                    if (data.code == 0) {
                        that.planStatereFlash()
                    }
                });
            },
            copyUrl(obj) {
                let oInput = document.createElement('input');
                oInput.value = obj;
                document.body.appendChild(oInput);
                oInput.select(); // 选择对象;
                document.execCommand("Copy"); // 执行浏览器复制命令
                this.$message({
                    message: '已成功复制到剪切板',
                    type: 'success'
                });
                oInput.remove()
            },
            jacocoReFlash() {
                var that = this;
                productid = that.form.product;
                jobname = that.form.service
                if (productid != '' & jobname != '') {
                    that.synchronize = '获取中';
                    _post_nl('/homepage/jacocoreport/', {
                        productid: productid,
                        jobname: jobname
                    }, function (data) {
                        data = JSON.parse(data);
                        if (data.code == 0) {
                            coverlist.forEach(function (item, index) {
                                rate = data.data[item]['percentageFloat'] != '' ? (data.data[item]['percentageFloat']).toFixed(2) : 0
                                // actjacoco[index].update(rate)
                                actjacoco[index].resize()
                                actjacoco[index].setOption(that.jacocoRepConfig(rate));

                            });
                            that.Coverage = data.data
                        } else {
                            that.$notify({
                                title: '获取结果',
                                message: data.msg,
                                type: 'warning',
                                dangerouslyUseHTMLString: true,
                                duration: 2000,
                                position: 'bottom-left'
                            });
                        }
                        that.synchronize = '获取'
                    })
                } else return
            },
            serviceChange(curdata) {
                if (curdata.indexOf(0) != -1) {
                    if (curdata[curdata.length - 1] == 0) {
                        this.form.service = [0]
                    } else {
                        curdata.splice(curdata.indexOf(0), 1)
                        this.form.service = curdata
                    }
                } else if (curdata[0] == 0) {
                    this.form.service = curdata.shift()
                }
                this.jacocoReFlash()
            },
            getReportChart() {
                var that = this;
                _post_nl('/homepage/reportchart/', {planid: that.form.plan.substr(5)}, function (result) {
                    result = JSON.parse(result);
                    echartsRecords.resize();
                    echartsRecords.setOption(that.reportconfig(result.data, result.code));
                });
            },
            reportChartCilck(obj) {
                if (obj.$el.id == 'pane-0') {
                    this.getReportChart()
                }
            },
            selectPlanVisible(obj) {
                if (!obj && this.form.plan != '') {
                    this.getReportChart()
                }
            },
            jacocoRun() {
                var that = this;
                that.jacocoRunstate = '请等待';
                _post_nl('/homepage/jenkinsJobRun/', {
                    productid: that.form.product, jobnames: that.form.service, action: 'jacoco'
                }, function (data) {
                    that.$notify({
                        title: '运行结果',
                        dangerouslyUseHTMLString: true,
                        message: data.data,
                        duration: 2000,
                        type: 'success',
                        position: 'bottom-left'
                    });
                    that.jacocoRunstate = '运行';
                })
            },
            getproductReport(rate, total) {
                var that = this;
                that.productRatenum = '共运行通过率:<br><p style="font-weight:bold">' + rate + "%</p>";
                that.productCountnum = '共运行次数:<br><p style="font-weight:bold">' + total + "</p>";
                option0 = {
                    color: ['rgba(253,174,57,1)'],
                    series: [
                        {
                            type: 'pie',
                            radius: ['85%', '95%'],
                            hoverAnimation: false,
                            label: {
                                normal: {
                                    show: true,
                                    position: 'center',
                                    textStyle: {
                                        fontSize: '22',
                                        fontWeight: '500',
                                        color: 'rgba(51,51,51,1)'
                                    },
                                },
                            },
                            data: [
                                {value: total, name: total}
                            ]
                        }
                    ]
                };
                option1 = {
                    color:['rgba(77,201,122,1)','rgba(242,242,242,1)'],
                    series: [
                        {
                            type: 'pie',
                            radius: ['85%', '95%'],
                            hoverAnimation: false,
                            label: {
                                normal: {
                                    show: true,
                                    position: 'center',
                                    textStyle: {
                                        fontSize: '22',
                                        fontWeight: '500',
                                        color: 'rgba(51,51,51,1)'
                                    },
                                },
                            },
                            data: [
                                {value: rate, name: rate + '%'},
                                {value: 100 - rate}
                            ]
                        }
                    ]
                };
                actproduct[0].resize();
                actproduct[0].setOption(option0);
                actproduct[1].resize();
                actproduct[1].setOption(option1);
            },
        },
        created: function () {
            this.getproduct();
        },
        watch: {
            'form.forceStopPlans': function (id) {
                var that = this;
                _post_nl('/homepage/queryPlanState/', {id: id}, function (data) {
                    that.runningState = data.data === 1 ? '运行' : '未运行'
                })
            },
            'form.third_plan': function (id) {
                var that = this;
                _post_nl('/homepage/query_third_call/', {planid: id.substr(5)}, function (data) {
                    that.form.is_verify_url = data.is_verify_url
                    that.form.debug_url = data.debug_url
                })
            },
            'log_text': function () {
                setTimeout(function () {
                    //设置滚动条到最底部
                    document.getElementById('log-process').scrollTop = document.getElementById('log-process').scrollHeight;
                }, 100);
            },
        },
    });
    echartsRecords = echarts.init(document.getElementById('echarts-records'), 'me2');
    coverlist = ['branchCoverage', 'classCoverage', 'instructionCoverage', 'complexityScore', 'lineCoverage', 'methodCoverage']
    actjacoco = [];
    coverlist.forEach(function (item, index) {
        actjacoco[index] = echarts.init(document.getElementById(item), 'me2');
        actjacoco[index].setOption(app.jacocoRepConfig(0))
    });
    window.onresize = function () {
        echartsRecords.resize();
    };

    productPiclist = ['productCount', 'productRate'];
    actproduct = []
    productPiclist.forEach(function (item, index) {
        actproduct[index] = echarts.init(document.getElementById(item), 'me2');
    });

    function ArraytoString(input) {
        let r = "";
        input.forEach(function (e) {
            r += " " + e;
        });
        return r.substr(1);
    }

    echartsRecords.on('click', function (params) {
        if (success_rate[params.dataIndex] !== 100) {
            taskid = taskids[params.dataIndex];
            app.queryOldBug(taskid);
            app.planHistoryVisible = true;
        } else {
            app.$message({
                message: '该次执行全部通过',
                type: 'success', center: true
            });
        }
    });


</script>
</body>
</html>

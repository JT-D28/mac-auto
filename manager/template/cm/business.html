{% load static %}
<!DOCTYPE html>
<html lang="en" style="height: 100%">
<head>
    <meta charset="UTF-8">
    <title>业务数据</title>
    <link rel="stylesheet" type="text/css" href="{% static 'manager/layui/css/layui.css' %}">
    <style type="text/css">

        .layui-input {
            padding: 0 14px;
            background-color: rgb(252, 252, 252);
        }

        .layui-form-item .layui-form-checkbox[lay-skin="primary"] {
            margin-right: 9px;
        }

        .layui-form-selectup dl {
            top: 42px;
            bottom: unset;
        }

        .layui-form-item .layui-inline {
            margin-bottom: 0px;
        }

        .layui-form-item .layui-input-inline,
        .layui-form-item .layui-inline {
            margin-right: 0;
        }
    </style>

</head>
<body style="height: 100%">
<div style="width: 100%;height: 6%;background:rgba(245,245,246,1);">
    <legend style="position: relative;top:50%;transform:translateY(-50%);padding-left: 30px">
                <span class="layui-breadcrumb">
                    <a href="">用例管理</a>
                    <a href="">测试点</a>
                </span>
    </legend>
</div>

<form id='addbusiness' class='layui-form' style="margin: 14px 30px 0 20px;height: calc(94% - 14px);">

    <div class="layui-form-item">
        <label class="layui-form-label">测试点</label>
        <div class="layui-input-block">
            <input type="text" name="businessname" placeholder="请输入" autocomplete="off"
                   class="layui-input"
                   lay-verify="required">
        </div>
    </div>
    <div class="layui-form-item ">
        <label class="layui-form-label required">备注信息</label>
        <div class="layui-input-block">
            <textarea name="description" id='description' placeholder=""
                      autocomplete="off" class="layui-textarea" lay-verify="required"
                      style="min-height:38px!important;height: 38px;line-height: 1.6;background:rgb(252, 252, 252)"></textarea>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-inline" style="width: 35%;">
            <label class="layui-form-label">权重</label>
            <div class="layui-input-inline" style="width: calc(100% - 110px)">
                <input type="text" name="weight" placeholder="请输入" autocomplete="off"
                       class="layui-input"
                       id='weight' disabled style="text-align: center;"></div>
        </div><div class="layui-inline" style="width: 35%;">
            <label class="layui-form-label">超时(秒)</label>
            <div class="layui-input-inline" style="width: calc(100% - 110px)">
                <input type="text" id='timeout' name="timeout" placeholder='' value='60'
                       autocomplete="off" class="layui-input" lay-verify="required" style="text-align: center;"></div>
        </div><div class="layui-inline" style="width: 30%;">
            <label class="layui-form-label">执行次数</label>
            <div class="layui-input-inline" style="width: calc(100% - 110px)">
                <input type="text" name="count" autocomplete="off" class="layui-input"
                       id='count' style="text-align: center;"></div>
        </div>

    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">前置操作</label>
        <div class="layui-input-block">
            <input type="text" id='pre' name="pre" placeholder="如dbexecute('select ..') 多个用|分隔,可以用变量"
                   autocomplete="off" class="layui-input" lay-verify="required">
        </div>
    </div>
    <div class="layui-form-item ">
        <label class="layui-form-label ">后置操作</label>
        <div class="layui-input-block">
            <input type="text" id='post' name="post" placeholder="同前置条件" autocomplete="off"
                   class="layui-input" lay-verify="required">
        </div>
    </div>
    <div class="layui-form-item ">
        <label class="layui-form-label required">接口校验</label>
        <div class="layui-input-block">
            <input type="text" id='itf_check' name="itf_check" placeholder="请输入" autocomplete="off"
                   class="layui-input" lay-verify="required">
        </div>
    </div>
    <div class="layui-form-item ">
        <label class="layui-form-label required">DB校验</label>
        <div class="layui-input-block">
            <input type="text" id='db_check' name="db_check" placeholder="请输入" autocomplete="off"
                   class="layui-input" lay-verify="required">
        </div>
    </div>
    <div class="layui-form-item " id="paramsitem" style="height: calc(100% - 395px)">
        <label class="layui-form-label required">参数信息</label>
        <div class="layui-input-block" style="height: 100%">
            <textarea name="params" id='params' placeholder="接口时输入json字符串 函数时直接输入参数,多个时,分隔"
                      autocomplete="off" class="layui-textarea" lay-verify="required"
                      style="min-height:130px!important;height: 100%"></textarea>
        </div>
    </div>

    <div class="layui-form-item" id="savaline" style="margin-bottom:0px">
        <button class="layui-btn" id='save' style="display: none;position: center;
        width:72px;margin-left:110px;height: 34px;line-height: 34px">保存
        </button>
    </div>
</form>


</body>


<script src="{% static 'manager/js/jquery.min.js' %}"></script>
<script src="{% static 'manager/layui/layui.js' %}"></script>
<script src="{% static 'manager/js/utils.js' %}"></script>
<script type="text/javascript">
    add_var_prop_smart_inputs(['pre', 'post', 'itf_check', 'db_check', 'params'])
    action = _get_query_param('action')

    layui.use(['table', 'element', 'form'], function () {

        var table = layui.table;
        var $ = layui.jquery
        var layer = layui.layer;
        var form = layui.form
        uid = _get_query_param('uid')
        pid = _get_query_param('pid')
        detail = 'addbusiness'

        if (action != 'view') {
            $('#save').css('display', 'inherit');
            $('#params').css('min-height', '90px')
            $('#paramsitem').css('height','calc(100% - 435px)')
        } else {
            $('#save').css('display', 'none')
            $('#savaline').css('height', 0)
            $('#weight_item').removeAttr('hidden')

            _set_form_not_editable()
        }

        // alert(uid)

        if (uid) {
            detail = 'editbusiness'
            success = function (d) {
                data = d.data[0]


                $("[name='weight']").val(data['weight'])
                $("[name='count']").val(data['count'])
                $("[name='businessname']").val(data['businessname'])
                $("[name='itf_check']").val(data['itf_check'])
                $("[name='db_check']").val(data['db_check'])
                $("[name='params']").val(data['params'])
                $("[name='pre']").val(data['preposition'])
                $("[name='post']").val(data['postposition'])
                $("[name='description']").val(data['description'])
                $("[name='timeout']").val(data['timeout'])

            };
            _post('/manager/queryonebusiness/', {'vid': uid}, success);

        }

        if (detail == 'addbusiness') {
            $("[name='count']").val(1)
        }


        //save

        btn = $('#save')
        if (btn) btn.bind('click', function () {
            data = {
                'uid': uid,
                'pid': pid,
                'action': detail,
                'businessname': $("[name='businessname']").val(),
                'itf_check': $("[name='itf_check']").val(),
                'db_check': $("[name='db_check']").val(),
                'params': $("[name='params']").val(),
                'preposition': $("[name='pre']").val(),
                'postposition': $("[name='post']").val(),
                'count': $("[name='count']").val(),
                'description': $("[name='description']").val(),
                'timeout': $('#timeout').val()

            }
            _post('/manager/treecontrol/', data, function (e) {
                if (e.code == 0) {
                    layer.alert(e.msg, {icon: 1, time: 2000})

                    var treeObj = parent.$.fn.zTree.getZTreeObj('case-manager');

                    if (detail == 'addbusiness') {
                        var node = treeObj.getNodeByParam('id', pid);
                        console.log('addbusiness=>' + JSON.stringify(e.data))
                        treeObj.addNodes(node, e.data);
                        treeObj.expandNode(node, true)

                    } else {
                        var node = treeObj.getNodeByParam('id', uid);
                        // console.log('search tid '+utid+'=>'+node)
                        node.name = e.data['name']
                        treeObj.updateNode(node)

                    }


                } else
                    layer.alert(e.msg, {icon: 2})


            });

            return false;


        });

    })

</script>

</html>

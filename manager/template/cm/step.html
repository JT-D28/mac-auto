{% load static %}
<!DOCTYPE html>
<html lang="en" style="height: 100%">
<head>
    <meta charset="UTF-8">
    <title>测试步骤</title>
    <link rel="stylesheet" type="text/css" href="{% static 'manager/layui/css/layui.css' %}">
    <style type="text/css">
        .layui-input {
            padding: 0 14px;
            background-color: rgb(252, 252, 252);
        }

        .layui-form-item .layui-form-checkbox[lay-skin="primary"] {
            margin-right: 9px;
        }

        .layui-form-selectup dl {
            top: 42px;
            bottom: unset;
        }

        {{UI_MENU_QXGL}}

    </style>

</head>
<body style="height: 100%">
<div style="width: 100%;height: 6%;background:rgba(245,245,246,1);">
    <legend style="position: relative;top:50%;transform:translateY(-50%);padding-left: 30px">
                <span class="layui-breadcrumb">
                    <a href="">用例管理</a>
                    <a href="">步骤</a>
                </span>
    </legend>
</div>
<form id='addstep' class="layui-form" style="margin: 14px 30px 0 20px;">
    <div class="layui-form-item" id='weight_item' hidden>
        <label class="layui-form-label ">权重</label>
        <div class="layui-input-block">
            <input id='weight' type="text" name="weight" placeholder="" autocomplete="off"
                   class="layui-input" disabled>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label required">执行次数</label>
        <div class="layui-input-block">
            <input type="text" name="count" placeholder="请输入" autocomplete="off" class="layui-input"
                   id='count'>
        </div>

    </div>


    <div class="layui-form-item">
        <label class="layui-form-label">步骤类型</label>
        <div class="layui-input-block"
             style="border: 1px solid #e6e6e6;background-color: rgba(252,252,252,1);padding: 0 14px;">
            <input type="radio" name="step_type" value="interface" title="接口" lay-filter='kind' checked>
            <input type="radio" name="step_type" value='function' title="函数" lay-filter='kind'>
            <input type="radio" name="step_type" value='dir' title="文件夹" lay-filter='kind'>
        </div>
    </div>
    <div class="layui-form-item ">
        <i id='importbusiness'
           class="layui-icon layui-icon-util"
           style="position: absolute;top:8px;right: 8px;visibility:hidden"></i>
        <label class="layui-form-label required">描述</label>
        <div class="layui-input-block">
            <input type="text" name="description" placeholder="请输入" autocomplete="off" class="layui-input"
                   lay-verify="required">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label required">url</label>
        <div class="layui-input-block">
            <textarea name="url" id='url' placeholder="请输入" autocomplete="off"
                      class="layui-textarea" lay-verify="required" style="min-height:38px!important;height: 38px;
                      background:rgb(252, 252, 252);line-height: 1.6"></textarea>
        </div>
    </div>
    <div class="layui-form-item" pane="">
        <label class="layui-form-label">content-type</label>
        <div class="layui-input-block"
             style="border: 1px solid #e6e6e6;background-color: rgba(252,252,252,1);padding: 0 14px;">
            <input type="radio" name="content-type" value="formdata" title="form-data" checked
                   lay-filter='content_type'>
            <input type="radio" name="content-type" value="urlencode" title="urlencode"
                   lay-filter='content_type'>
            <input type="radio" name="content-type" value='json' title="json" lay-filter='content_type'>
            <input type="radio" name="content-type" value='xml' title="xml" lay-filter='content_type'>
        </div>
    </div>
    <div class="layui-form-item" id='header-div'>
        <label class="layui-form-label">请求头</label>
        <div class="layui-input-block">
            <input type="text" id='header' name="header" placeholder="请输入" autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item" pane="" id='method-div'>
        <label class="layui-form-label">method</label>
        <div class="layui-input-block"
             style="border: 1px solid #e6e6e6;background-color: rgba(252,252,252,1);padding: 0 14px;">
            <input type="radio" name="method" value="get" title="GET">
            <input type="radio" name="method" value='post' title="POST" checked>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">属性</label>
        <div class="layui-input-block">
            <input type="text" id='property' name="property"
                   placeholder="这里定义如{'token':'data.value.token'} 使用时用${token}" autocomplete="off"
                   class="layui-input">
        </div>
    </div>


    <div class="layui-form-item" hidden>
        <label class="layui-form-label required">调用函数</label>
        <div class="layui-input-block">
            <select name='body'></select>
        </div>
    </div>

    <div class="layui-form-item" style="margin-bottom: 0">
        <label class="layui-form-label">DB选择</label>
        <div class="layui-input-block">
            <select name="db_id" lay-verify="" lay-search>
            </select>
        </div>
    </div>


    <div class="layui-form-item" style="margin-bottom: 0">
        <button class="layui-btn" id='save' style="display: none;position: center;
        width:72px;margin-left:110px;height: 34px;line-height: 34px">保存
        </button>
    </div>
</form>


</body>
<script src="{% static 'manager/js/jquery.min.js' %}"></script>
<script src="{% static 'manager/layui/layui.js' %}"></script>
<script src="{% static 'manager/js/utils.js' %}"></script>


<script type="text/javascript">
    function selectinterface() {
        $("[name='url']").parent().parent().show();
        $("[name='body']").parent().parent().hide();
        $("[name='header']").parent().parent().show();
        $("[name='method']").parent().parent().show();
        $("[name='content-type']").parent().parent().show();
        $("[name='itf-check']").parent().parent().show();
        $("[value='interface']").attr('checked', 'checked');
        $("[value='function']").removeAttr('checked');
        $("[name='property']").parent().parent().show();
        $("[name='db_id']").parent().parent().show()
    }

    function selectfunction() {
        $("[name='url']").parent().parent().hide();
        $("[name='body']").parent().parent().show();
        $("[name='header']").parent().parent().hide();
        $("[name='method']").parent().parent().hide();
        $("[name='content-type']").parent().parent().hide();
        $("[name='itf-check']").parent().parent().hide();
        $("[value='function']").attr('checked', 'checked');
        $("[value='interface']").removeAttr('checked')
        $('#importbusiness').css('visibility', 'hidden');

    }

    function selectdir() {
        $("[name='url']").parent().parent().hide();
        $("[name='header']").parent().parent().hide();
        $("[name='method']").parent().parent().hide();
        $("[name='content-type']").parent().parent().hide();
        $("[name='itf-check']").parent().parent().hide();
        $("[name='db-check']").parent().parent().hide();
        $("[name='body']").parent().parent().hide();
        $("[name='property']").parent().parent().hide();
        $("[name='db_id']").parent().parent().hide();
        $('#importbusiness').css('visibility', 'hidden');
    }


    add_var_prop_smart_inputs(['url', 'header', 'property']);
    layui.use(['table', 'layer', 'element', 'form'], function () {
        var table = layui.table;
        var $ = layui.jquery;
        var layer = layui.layer;
        var form = layui.form;
        var element = layui.element;
        uid = _get_query_param('uid');
        pid = _get_query_param('pid');

        $("#importbusiness").click(function () {
            if ($("[name='description']").val() != '') {
                layer.prompt({title: '请先输入测试点描述，并确认', formType: 3}, function (bussiness_des, index) {
                    layer.close(index);
                    layer.prompt({
                        title: '粘贴请求', formType: 2, area: ['500px', '300px'],
                        maxlength: 1000000000
                    }, function (text, index) {
                        layer.close(index);
                        _post('/manager/getParamfromFetchData/', {
                            'uid': uid,
                            'pid': pid,
                            'description': $("[name='description']").val(),
                            'bussiness_des': bussiness_des,
                            'fetchtest': text
                        }, function (e) {
                            if (e.code === 0) {
                                var treeObj = parent.$.fn.zTree.getZTreeObj('case-manager');
                                id = pid ? pid : uid;
                                var node = treeObj.getNodeByParam('id', id);
                                console.log('addstep=>' + JSON.stringify(e.data));
                                treeObj.addNodes(node, e.data);
                                treeObj.expandNode(node, true)
                                layer.alert('新增成功', {icon: 1})
                            } else
                                layer.alert(e.data, {icon: 2})
                        });
                    });
                });
            } else {
                layer.msg('请先输入描述')
            }
        });


        //加载函数列表
        _post('/manager/queryfunclist/', {}, function (data) {
            console.log('函数列表信息=>' + data);
            data = JSON.parse(data);
            data = data.data;
            for (var index = 0; index < data.length; index++) {
                $("[name='body']").append("<option value='" + data[index]['value'] + "'>" + data[index]['description'] + "</option>")
            }
            layui.form.render('select')
        });
        form.on('radio(kind)', function (data) {
            //v=$("[name='step_type']").val()
            v = data.value;
            // console.log("选择"+v)
            if (v === 'interface') {
                selectinterface();
                $('#importbusiness').css('visibility', 'visible');
            } else if (v === 'function')
                selectfunction()
            else
                selectdir()
        });

        form.on('radio(content_type)', function (data) {
            if (data.value == 'xml') {
                $('#header-div').hide();
                $('#method-div').hide()
            } else {
                $('#header-div').show();
                $('#method-div').show()
            }
        });

        action = _get_query_param('action');

        // alert(action)
        detail = 'addstep';
        // alert(detail)

        if (action != 'view') {
            $('#save').css('display', 'inherit');
            $('#save').css('margin-top','14px')
            $('#importbusiness').css('visibility', 'visible');
        } else {
            $('#weight_item').removeAttr('hidden');
            _set_form_not_editable();
        }


        if (uid) {
            detail = 'editstep';
            _post('/manager/querydblist/', {schemevalue: '', id: uid}, function (res) {
                $("[name='db_id']").empty();
                res = JSON.parse(res);
                if (res.code === 0) {
                    for (var index = 0; index < res.data.length; index++) {
                        $("[name='db_id']").append("<option value='" + res.data[index]['name'] + "'>" + res.data[index]['name'] + "</option>")
                    }
                    console.log('加载数据库信息列表成功');
                    layui.form.render('select');
                    success = function (data) {
                        count = data.data[0]['count'];
                        weight = data.data[0]['weight'];
                        step_type = data.data[0]['step_type'];
                        description = data.data[0]['description'];
                        url = data.data[0]['url'];
                        method = data.data[0]['method'];
                        headers = data.data[0]['headers'];
                        body = data.data[0]['body'];
                        content_type = data.data[0]['content_type'];
                        itf_check = data.data[0]['itf_check'];
                        db_check = data.data[0]['db_check'];
                        tmp = data.data[0]['temp'];
                        if ('interface' === step_type)
                            selectinterface();
                        else if ('function' === step_type)
                            selectfunction();
                        else
                            selectdir();
                        $("[name='count']").val(count);
                        $("[name='weight']").val(weight);
                        $("[name='description']").val(description);
                        $("[name='url']").val(url);
                        $("[value='" + method + "']").attr('checked', 'checked');
                        $("[name='header']").val(headers);
                        $("[name='body']").val(body);
                        $("[value='urlencode']").removeAttr('checked');
                        $("[value='json']").removeAttr('checked');
                        $("[value='xml']").removeAttr('checked');
                        $("[value='" + content_type + "']").attr('checked', 'checked');
                        if (content_type === 'xml') {
                            $('#header-div').hide();
                            $('#method-div').hide()
                        }
                        layui.form.render('radio');
                        $("[name='itf-check']").val(itf_check);
                        $("[name='db-check']").val(db_check);
                        $("[name='property']").val(tmp);
                        $("[name='db_id']").val(data.data[0]['db_id']);

                        layui.form.render('select')
                    };
                    _post('/manager/queryonestep/', {id: uid}, success);
                } else {
                    layer.alert('数据库信息查询失败', {icon: 2})
                }
            });
        } else {
            _load_db_dropdownlist('', pid)
        }

//set default
        if (detail === 'addstep') {
            $("[name='count']").val(1)
        }


        btn = $('#save')

        if (btn) btn.bind('click', function (e) {
            layui.form.render('select')

            console.log('step click');
            //alert($('#ect'))
            data = {
                'uid': uid,
                'pid': pid,
                'action': detail,
                'step_type': $("[name='step_type']:checked").val(),
                'description': $("[name='description']").val(),
                'url': $("[name='url']").val(),
                'method': $("[name='method']:checked").val(),
                'headers': $("[name='header']").val(),
                'body': $("[name='body']").val(),
                'content_type': $("[name='content-type']:checked").val(),
                'tmp': $("[name='property']").val(),
                'dbid': $("[name='db_id']").val(),
                'count': $("[name='count']").val(),
                // 'node_type':$("[name='node_type']:checked").val(),

            };

            // alert(data)
            _post('/manager/treecontrol/', data, function (e) {
                //alert(e.code)

                if (e.code === 0) {
                    var treeObj = parent.$.fn.zTree.getZTreeObj('case-manager');

                    if (detail === 'addstep') {
                        var node = treeObj.getNodeByParam('id', pid);
                        console.log('addstep=>' + JSON.stringify(e.data));
                        treeObj.addNodes(node, e.data);
                        treeObj.expandNode(node, true)

                    } else {
                        var node = treeObj.getNodeByParam('id', uid);
                        // console.log('search tid '+utid+'=>'+node)
                        node.name = e.data['name'];
                        treeObj.updateNode(node)

                    }
                    layer.alert(e.msg, {icon: 1, time: 2000})
                } else
                    layer.alert(e.msg, {icon: 2})
            });

            return false

        });


    });


</script>


</html>

{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>MEE_V2.0</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta name="viewport"
          content="width=device-width,height=device-height,initial-scale=0.8, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" type="text/css" href="{% static 'manager/layui/css/layui.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'manager/css/index.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'manager/css/toast.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'manager/font-awesome-4.7.0/css/font-awesome.min.css' %}">
    <style type="text/css">

        .UI_MENU_YHGL{
            display: {{UI_MENU_YHGL}};
        }

        .UI_MENU_QXGL{
            display: {{UI_MENU_QXGL}};
        }
        .UI_MENU_JSGL{
            display: {{UI_MENU_JSGL}}
        }

        .UI_MENU_BWMB{
            display: {{UI_MENU_BWMB}}
        }
        .UI_CONFIG_GLOBAL_SET{
            display: {{UI_CONFIG_GLOBAL_SET}}
        }

        p span{
            width: 24px;
            height: 17px;
            font-size: 12px;
            font-family: PingFang-SC-Medium, PingFang-SC;
            font-weight: 500;
            color: rgba(0, 151, 136, 1);
            line-height: 17px;
            margin-left:2px;
        }

        #msgview {
            padding: 20px;
        }

        .console-line-msg {
            margin-top: 12px;
        }

        .success {
            color: green;
        }

        .fail {
            color: red;
        }

        .skip {
            color: #000000;
        }

        cite {
            vertical-align: middle;
        }

        .icon {
            margin-right: 10px;
            width: 14px;
        }

        .layui-layout-admin .layui-header {
            background-color: rgba(255, 255, 255, 1);
            min-height: 60px;
        }

        .layui-nav .layui-nav-item > a {
            padding-left: 26px;
        }

        .textcolor {
            font-size: 12px !important;
            font-family: PingFangSC-Regular, PingFang SC !important;
            font-weight: 400 !important;
            color: rgba(102, 102, 102, 1) !important;
            line-height: 17px !important;
        }

        .sideicon {
            width: 16px;
            height: 16px;
            padding-right: 10px;
            padding-bottom: 0.2px;
            opacity: 0.8;
        }

        .layui-this > a > img {
            opacity: 1;
        }

        #usernews{
           /* overflow-y:scroll;*/
            background-color: #eee;
            
            width:300px;
            height:100%;
            z-index:99999;
            position:fixed;
            right:0;
            top:65;
            display:none;
            overflow-y:auto;
        }

        #closenews:hover{
            cursor: pointer;
        }
        li span:hover{
            cursor: pointer;

        }
        .layui-text h3{
            font-size:14px;
        }
        .layui-text p{
            font-size:10px;
        }
        body::-webkit-scrollbar {
            display: none;
        }

        #wd,#yd{
            overflow-y:hidden;
        }
    </style>
}
}
</head>
<body class="main_body" zoom:0.8>

<div class="layui-layout layui-layout-admin">
    <!-- 顶部 -->
    <div class="layui-header header"
         style="left: 200px;width: calc(100% - 200px);border-bottom:1px solid rgba(234,234,234,1)">
        <div class="layui-main mag0" style="margin: 0">
            <!-- 显示/隐藏菜单 -->
            <a href="javascript:;" style="margin:15px 20px;background-color:white"
               class="seraph hideMenu"><img src="{% static 'manager/icon/hide.svg' %}"
                                            style="width:18px;height:18px;padding-right: 10px"></a>
            <!-- 顶部右侧菜单 -->
            <ul class="layui-nav top_menu">
                <li class="layui-nav-item" style="margin-left: 30px;" id='head'>

                    <img src="{% static 'manager/image/me.jpg' %}" style="padding: 0" class="layui-nav-img">
                    <i id='username' class="textcolor">{{ request.session.username }}</i>
                </li>
 
                    <li class="layui-nav-item UI_CONFIG_GLOBAL_SET" style="margin-left: 30px;"><a style="padding: 0" class="textcolor"href="#" id='globalsetting'><img
                            src="{% static 'manager/icon/setting.svg' %}"
                            style="width:18px;height:18px;padding-right: 10px">全局设置</a></li>
           
                <li class="layui-nav-item" style="margin-left: 30px;"><a class="textcolor" style="padding: 0" href="#"
                                                                         id='console'><img
                        src="{% static 'manager/icon/monitor.svg' %}"
                        style="width:13px;height:13px;padding-right: 10px">控制台</a></li>
                <li class="layui-nav-item" style="margin-left: 30px;"><a class="textcolor" style="padding: 0" href="#"
                                                                         id='recvmsg'>消息<span class='{{user_news_status}}'></span></a>

                                                                     </li>
                <li class="layui-nav-item" style="margin-left: 30px;margin-right: 5px"><a class="textcolor"
                                                                                          style="padding: 0"
                                                                                          href="{{ BASE_URL }}/account/logout/"><img
                        src="{% static 'manager/icon/logout.svg' %}" style="width:13px;height:13px;padding-right: 10px">退出</a>
                </li>
            </ul>

        </div>
    </div>

    <div id='usernews'>
        <i class="layui-icon layui-icon-close" id ='closenews' style="position:absolute;right:0;z-index:10000;"></i>

        <div class="layui-tab">
          <ul class="layui-tab-title">
            <li class="layui-this">未读</li>
            <li>已读</li>
          </ul>
          <div class="layui-tab-content" style="padding:5px!important">
            <div class="layui-tab-item layui-show" id='wd'></div>
            <div class="layui-tab-item" id='yd'></div>
          </div>
        </div>
 
    </div>
    <!-- 左侧导航 -->
    <div class="layui-side layui-bg-black" style="z-index: 2003;top: 0px!important;">
        <a href="#" class="logo">
            <img i="icon" src="{% static 'manager/icon/logo.svg' %}" style="text-align:left;padding-right: 10px">
        </a>
        <div class="navBar layui-side-scroll" id="navBar" style="width: 200px">
            <ul class="layui-nav layui-nav-tree" style="margin-top: 12px;">
                <li class="layui-nav-item layui-this">
                    <a href="javascript:;" data-url="/homepage/"><img class="sideicon"
                                                                      src="{% static 'manager/icon/home.svg' %}"><cite>首页</cite></a>
                </li>
                    <li class="UI_MENU_YHGL layui-nav-item">
                        <a href="javascript:;" data-url="/account/user/"><i class="fa fa-user icon"
                                                                            style="padding-left: 2.1px;padding-bottom:2.5px;opacity:0.8"></i><cite>用户管理</cite></a>
                    </li>

                    <li class="layui-nav-item UI_MENU_JSGL">
                        <a id='tree' href="javascript:;" data-url="/account/role/"><img i="icon"
                                                                                        src="{% static 'manager/icon/app.svg' %}"
                                                                                        class="sideicon"><cite>角色管理</cite></a>
                    </li>


                 <!--   <li class="layui-nav-item UI_MENU_QXGL">
                        <a href="javascript:;" data-url="/manager/authcontrol/"><img i="icon"
                                                                                     src="{% static 'manager/icon/template.svg' %}"
                                                                                     class="sideicon"><cite>权限控制</cite></a>
                    </li>-->
                <li class="layui-nav-item">
                    <a id='tree' href="javascript:;" data-url="/manager/tree/"><img i="icon"
                                                                                    src="{% static 'manager/icon/app.svg' %}"
                                                                                    class="sideicon"><cite>用例管理</cite></a>
                </li>
                <li class="layui-nav-item">
                    <a href="javascript:;" data-url="/manager/dbcon/"><img i="icon"
                                                                           src="{% static 'manager/icon/link.svg' %}"
                                                                           class="sideicon"><cite>数据连接</cite></a>
                </li>
                <li class="layui-nav-item">
                    <a href="javascript:;" data-url="/manager/var/"><img i="icon"
                                                                         src="{% static 'manager/icon/var.svg' %}"
                                                                         class="sideicon"><cite>变量管理</cite></a>
                </li>
                <li class="layui-nav-item">
                    <a href="javascript:;" data-url="/manager/function/"><img i="icon"
                                                                              src="{% static 'manager/icon/func.svg' %}"
                                                                              class="sideicon"><cite>函数定义</cite></a>
                </li>
                <li class="layui-nav-item">
                    <a href="javascript:;" data-url="/manager/datamove/"><img i="icon"
                                                                              src="{% static 'manager/icon/move.svg' %}"
                                                                              class="sideicon"><cite>数据迁移</cite></a>
                </li>
                <li class="layui-nav-item">
                    <a href="javascript:;" data-url="/manager/uploadfile/"><img i="icon"
                                                                                src="{% static 'manager/icon/space.svg' %}"
                                                                                class="sideicon"><cite>我的空间</cite></a>
                </li>

                <li class="layui-nav-item">
                    <a href="javascript:;" data-url="/manager/template/"><img i="icon"
                                                                              src="{% static 'manager/icon/template.svg' %}"
                                                                              class="sideicon"><cite>报文模板</cite></a>
                </li>

                <li class="layui-nav-item">
                    <a href="javascript:;" data-url="/manager/help/"><img i="icon"
                                                                          src="{% static 'manager/icon/help.svg' %}"
                                                                          class="sideicon"><cite>帮助文档</cite></a>
                </li>
            </ul>
        </div>
    </div>
    <!-- 右侧内容 -->
    <div class="layui-body layui-form" style="bottom:0px;top: 60px!important;border-left:0px">
        <div class="layui-tab mag0" lay-filter="bodyTab" id="top_tabs_box" style="margin-top: 0px">
            <ul class="layui-tab-title top_tab" id="top_tabs" hidden>
                <li class="layui-this" lay-id=""><i class="layui-icon">&#xe68e;</i> <cite>首页</cite></li>
            </ul>
            <div class="layui-tab-content clildFrame" style="top:0">
                <div class="layui-tab-item layui-show">
                    <iframe id='iframe' src="/homepage/"></iframe>
                </div>
            </div>
        </div>
    </div>
</div>

<form id='addsetting' hidden style="padding:10px;">
    <div class="layui-form-item">
        <label class="layui-form-label">me2地址：</label>
        <div class="layui-input-block">
            <input type="text" name="me2url" placeholder="请输入工具当前地址，类似：10.60.44.54:9999" autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">redis地址：</label>
        <div class="layui-input-block">
            <input type="text" name="redisurl" placeholder="请输入redis的地址和端口，类似：10.60.44.54:6379" autocomplete="off"
                   class="layui-input">
        </div>
    </div>
</form>

<div id='consoleview'>
    <div id="msgview" style="padding:10px;"></div>
</div>


<script src="{% static 'manager/js/jquery.min.js' %}"></script>
<script src="{% static 'manager/js/jquery.scrollify.min.js' %}"></script>
<script src="{% static 'manager/js/jquery.easing.1.3.js' %}"></script>
<script src="{% static 'manager/js/utils.js' %}"></script>
<script src="{% static 'manager/layui/layui.js' %}"></script>
<script src="{% static 'manager/js/index.js' %}"></script>
<script src="{% static 'manager/js/toast.js' %}"></script>


<script type="text/javascript">
    layui.use(['layer','element'], function () {
        var $ = layui.$;
        var layer = layui.layer;
        var element = layui.element;
        //控制台弹出
        var consoleSocket = undefined
        var username = $("#username").text()
        var taskkeys = []
        var curtaskindex = 0


        $("#head").dblclick(function () {
            layer.msg('调试切换', {
                btn: ['模式', '工具', '取消']
                , btn1: function (index, layero) {
                    _post_nl('/manager/changemode/', {action: 'debug'}, function (data) {
                        if (data.code === 0) {
                            layer.close(index);
                            layer.msg(data.msg);
                            setTimeout(function () {
                                window.top.location.reload()
                            }, 2000)
                        }
                    });
                }, btn2: function (index) {
                    _post_nl('/manager/changemode/', {action: 'debug_tool'}, function (data) {
                        if (data.code === 0) {
                            layer.close(index);
                            layer.msg(data.msg);
                            setTimeout(function () {
                                window.top.location.reload()
                            }, 2000)
                        }
                    });
                }, btn3: function (index) {
                    layer.close(index)
                }
            });
        });

        $("#console").click(function () {
            _post_nl('/homepage/querytaskid/', {'action': 'lastest'}, function (data) {
                data = JSON.parse(data)
                let consoleSocket = new WebSocket("ws://" + host + "/ws/consolemsg/");
                consoleSocket.onopen = function () {
                    // var username=$("#username").text()
                    console.log("开始获取" + username + "控制台消息..")
                    consoleSocket.send('console.msg::read::' + username + '::' + data.data)
                };
                consoleSocket.onmessage = function (e) {
                    console.log(e.data);
                    if (e.data.indexOf("hasRead") === -1)
                        $("#msgview").append("<p class='console-line-msg'>" + e.data + "</p>")
                    else {
                        //$("#taskids").text(e.data)
                        //taskkeys = e.data.split('[key-value]')[1].split(",")
                        //console.log("设置taskkeys=>", taskkeys)
                        $("#msgview").append("<p class='console-line-msg'>最新的运行日志缓存已经读取过</p>")
                    }
                }
                consoleSocket.onclose = function () {
                    console.log("结束获取控制台消息..")
                }
                var o = layer.open({
                    title: '运行消息',
                    type: 1,
                    content: $('#consoleview'),
                    btn: ['关闭'],
                    area: ["750px", "450px"],
                    maxmin: true,
                    yes: function (index, layero) {
                        consoleSocket.close()
                        $("#msgview").empty()
                        layer.close(index)
                    },
                    cancel: function (index, layero) {
                        consoleSocket.close()
                        $("#msgview").empty()
                    },
                });
                layer.full(o);
            })
        });


        $('#globalsetting').click(
            function () {
                layer.open({
                    type: 1,
                    title: "全局设置",
                    content: $('#addsetting'),
                    area: ['600px', '260px'],
                    offset: 'auto',
                    shade: [0.1, '#393D49'],
                    shadeClose: true,
                    btn: ['确认后请手动重启服务', '取消'],
                    success: function () {
                        $.ajax({
                            url: '/homepage/globalsetting/',
                            type: 'GET',
                            dataType: 'json',
                            success: function (res) {
                                res = JSON.parse(res)
                                $("[name='me2url']").val(res.data['me2url']),
                                    $("[name='redisurl']").val(res.data['redisip'] + ":" + res.data['redisport'])
                            }
                        })
                    },
                    yes: function (index, layero) {
                        $.ajax({
                            url: '/homepage/globalsetting/',
                            type: 'POST',
                            dataType: 'json',
                            data: {
                                'me2url': $("[name='me2url']").val(),
                                'redisurl': $("[name='redisurl']").val()
                            },
                            success: function (res) {
                                res = JSON.parse(res)
                                if (res.code == 0) {
                                    layer.close(index)
                                    layer.alert("重启后，请重新加载页面！", {icon: 1, time: 3000})
                                } else {
                                    layer.alert(res.msg, {icon: 5, time: 3000})
                                }
                            }
                        })
                    },
                    btn2: function (index, layero) {
                        layer.close(index)
                    },
                    cancel: function (index, layero) {
                        layer.close(index)
                    }
                })
            }
        );

        $('#recvmsg').click(function(){

            $('#yd').empty()
            $('#wd').empty()
            tmp='<li class="layui-timeline-item" id="#id#" full="#full#">'+
                    '<div class="layui-timeline-content layui-text">'+
                    '<h3 class="layui-timeline-title" >#title#</h3><p>#msg#'+
                    '<span>已读</span><span>详情</span></p></div> </li>'
                      
            _post_nl('/manager/getusernews/',{},function(data){

                for(var i=0;i<data.length;i++){
                    simple=data[i]['description']
                    if(data[i]['description'].length>22)
                        simple=data[i]['description'].substring(0,16)+'..'

                    tmp1=tmp.replace('#title#','['+data[i]['createtime']+']'+data[i]['title'])
                    tmp1=tmp1.replace('#full#',data[i]['description'])
                    tmp1=tmp1.replace('#msg#',simple)
                    tmp1=tmp1.replace('#id#',data[i]['id'])
                    if(data[i]['is_read']==0){
                        
                        $('#wd').append(tmp1)

                    }else{
                        $('#yd').append(tmp1)
                        $('#yd span').each(function(){
                            $(this).hide();
                        })
                    }

                    //

                }

                $('#wd li').each(function(){
                    var el=$(this)
                    delbtn=$(this).find('span').eq(0)
                    delbtn.click(function(){
                        layer.msg('ok..')
                        var this_=this
                        _post_nl('/manager/hasread/',{uid:el.attr('id')},function(e){
                            if(e.code==0){

                                el.remove()
                                layer.msg('标为已读')
                                $('#yd').prepend(el.html())
                                //
                                $('#yd span').each(function(){
                                    $(this).hide();
                                });
                            }
                        })

                    });
                    detailbtn=$(this).find('span').eq(1)
                    detailbtn.click(function(){
                        layer.open({
                            title:'消息详情',
                            btn:['标为已读','关闭'],
                            content:el.attr('full'),
                            yes:function(index,layero){
                                layer.close(index)
                                _post_nl('/manager/hasread/',{'uid':el.attr('id')},function(e){
                                        if(e.code==0){
                                            el.remove()
                                            layer.msg('标为已读')
                                            $('#yd').prepend(el.html())
                                            //
                                            $('#yd span').each(function(){
                                                $(this).hide();
                                     });
                            }



                                })

                            }
                        })


                    });


                });


                $('#usernews').show()
            })


        });

        $('#closenews').click(function(){
            $('#usernews').hide()
        })



        function setIframeHeight(iframe) {
            if (iframe) {
                var iframeWin = iframe.contentWindow || iframe.contentDocument.parentWindow;
                if (iframeWin.document.body) {
                    iframe.height = iframeWin.document.documentElement.scrollHeight || iframeWin.document.body.scrollHeight;
                    console.log(iframe.height)
                }
            }
        };
        window.onload = function () {
            setIframeHeight(document.getElementById('iframe'));
        };

    });

    $.scrollify({
        section: 'li',
        target: 'body'
    });

    $(document).ready(function () {
        connect_on();
    });

</script>

</body>
</html>

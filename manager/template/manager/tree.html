
{% load static %}
<!DOCTYPE html>
<html style="height: 100%">
<head>
    <meta charset="utf-8">
    <title>树组件</title>
    <link rel="stylesheet" type="text/css" href="{% static 'manager/ztree/zTreeStyle.css' %}">
    <!--   <link rel="stylesheet" type="text/css" href="{% static 'manager/ztree/demo.css' %}"> -->
    <link rel="stylesheet" type="text/css" href="{% static 'manager/icomoon/style.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'manager/font-awesome-4.7.0/css/font-awesome.min.css' %}">

    <link rel="stylesheet" type="text/css" href="{% static 'manager/bootstrap/bootstrap.min.css' %}">
    <link href="{% static 'manager/bootstrap-fileinput-master/css/fileinput.css' %}" media="all" rel="stylesheet"
          type="text/css"/>
    <link href="{% static 'manager/bootstrap-fileinput-master/themes/explorer-fas/theme.css' %}" media="all"
          rel="stylesheet" type="text/css"/>

    <link rel="stylesheet" type="text/css" href="{% static 'manager/layui/css/layui.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'manager/css/rightMenu.css' %}">


    <style type="text/css">
        .layui-input {
            padding: 0 14px;
            background-color: rgb(252, 252, 252);
        }

        .layui-form-item .layui-form-checkbox[lay-skin="primary"] {
            margin-right: 9px;
        }

        .layui-form-selectup dl {
            top: 42px;
            bottom: unset;
        }

        span {
            font-size: 14px;
            font-family: PingFang-SC-Regular, PingFang-SC;
            font-weight: 400;
            color: rgba(51, 51, 51, 1);
            line-height: 20px;
        }

        .layui-tree-entry {
            height: auto;
            padding: 4px 0;
        }

        .layui-tree-iconClick {
            margin-right: 8px;
            margin-left: 0px;
        }

        .layui-table-view {
            margin: 0 0;
        }

        .layui-table th, .layui-table td {
            font-size: 12px;
        }

        .card {
            padding: 0 25px;
            line-height: 30px;
            height: 30px;
        }

        .ztree li span.button.add {
            margin-left: 2px;
            margin-right: -1px;
            background-position: -144px 0;
            vertical-align: top;
            *vertical-align: middle
        }

        .ztree li span.button.diy01_ico_open, .ztree li span.button.diy01_ico_close {
            margin-right: 2px;
            background: url(../../static/manager/ztree/img/diy/1_open.png) no-repeat scroll 0 0 transparent;
            vertical-align: top;
            *vertical-align: middle
        }

        .ztree li span.button.diy02_ico_docu {
            margin-right: 2px;
            background: url(../../static/manager/ztree/img/diy/2.png) no-repeat scroll 0 0 transparent;
            vertical-align: top;
            *vertical-align: middle
        }

        .ztree li span.button.diy03_ico_docu {
            margin-right: 2px;
            background: url(../../static/manager/ztree/img/diy/3.png) no-repeat scroll 0 0 transparent;
            vertical-align: top;
            *vertical-align: middle
        }

        .fa {

            /*color: #FF6699;*/
            color: #009688;

        }

        .btn {
            width: 72px;
            height: 34px;
            background: rgba(0, 151, 136, 1);
            border-radius: 0px 2px 2px 0px;
        }

        .btn-text {
            width: 24px;
            height: 17px;
            font-size: 12px;
            font-family: PingFang-SC-Medium, PingFang-SC;
            font-weight: 500;
            color: rgba(255, 255, 255, 1);
            line-height: 17px;
        }


        .fa.fa-folder {
            color: #FFCC66;

        }

        .fa.fa-folder-open {
            color: #FFCC66;
        }

        #start-record:hover{
            cursor: pointer;

        }
        #end-record:hover{
            cursor: pointer;
        }


    </style>
</head>
<body style="height:100%;">
<script>


    function changeFrameHeight() {
        var ifm = document.getElementById("tree-content");
        ifm.maxHeight = ifm.height = document.documentElement.clientHeight;
    }

    window.onresize = function () {
        changeFrameHeight();
    }

</script>




<form id='rform' hidden style="padding:10px;" class="layui-form">
  <div class="layui-form-item">
    <label class="layui-form-label">作用于</label>
    <div class="layui-input-block">
      <input type="checkbox" name="planname" title="计划名" lay-skin="primary" checked>
      <input type="checkbox" name="casename" title="用例名" lay-skin="primary" checked>
      <input type="checkbox" name="stepname" title="步骤名" lay-skin="primary" checked>
      <input type="checkbox" name="stepurl" title="步骤url" lay-skin="primary" checked>
      <input type="checkbox" name="header" title="请求头" lay-skin="primary" checked>
      <input type="checkbox" name="property" title="属性" lay-skin="primary" checked>
      <input type="checkbox" name="businessname" title="测试点名" lay-skin="primary" checked>
    <input type="checkbox" name="params" title="测试参数" lay-skin="primary" checked>
    </div>
  </div>
    <div class="layui-form-item">
        <label class="layui-form-label">待替换</label>
        <div class="layui-input-block">
            <textarea name="old" id='old' placeholder="字符串&正则表达式,正则无法回退"
                      autocomplete="off" class="layui-textarea" lay-verify="required"
                      style="min-height:38px!important;height: 38px;line-height: 1.6;background:rgb(252, 252, 252)"></textarea>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">替换为</label>
        <div class="layui-input-block">
            <textarea name="new" id='new' placeholder="影响相关子节点数据"
                      autocomplete="off" class="layui-textarea" lay-verify="required"
                      style="min-height:38px!important;height: 38px;line-height: 1.6;background:rgb(252, 252, 252)"></textarea>
        </div>
    </div>


</form>
<div id='treelist' class="layui-col-md5 " style="max-height:100%;overflow-y:auto;padding: 20px;height: 100%">
    <div class="layui-inline">
        <input type="input" name="" placeholder="search"
               style='padding:0 14px;width:280px;height:34px;background:rgba(255,255,255,1);border-radius:2px;border:1px solid rgba(220,222,224,1);'
               id='search' autocomplete="off"><button id='searchbtn' class="layui-btn" style="vertical-align:revert;height: 34px;line-height: 34px">
        <span class='btn-text'>查询</span></button>

        <br/>
        {% if request.session.username == 'hujj' %}
        <i id="start-record">开始录制</i><i id="end-record">结束录制</i>
        <i id='map'>关联</i>
        {% endif %}


    </div>
    <ul class="contextmenu" id="contextmenu"></ul>
    
    
    <ul id="case-manager" class="ztree" style="margin-bottom: 20px;padding:10px 0 0 15px "></ul>

</div>

<div class="layui-col-md7" style="min-height:100%;overflow-y:auto;">
    <iframe id='tree-content' name='tree-content' title="test" scrolling="yes" frameborder="0" src=""
            style="overflow-y:auto;width:100%;" onload="changeFrameHeight()"></iframe>

</div>


<div id="test" hidden class="layui-row" style="height: 100%;">
    <div class="layui-col-md2 " style="height:100%;border-right:4px solid #f6f6f6;overflow-y:auto;">
        <div class="layui-card">
            <div class="layui-card-header card">用例:</div>
            <div class="layui-card-body" style="padding: 0 8px">
                <ul id="demo1"></ul>
            </div>
        </div>
    </div>

    <div class="layui-col-md2 " style="height:100%;border-right:4px solid #f6f6f6;overflow-y:auto;">
        <div class="layui-col-md12" style="height: 45%;overflow-y:auto;">
            <div class="layui-card">
                <div class="layui-card-header card">步骤:</div>
                <div class="layui-card-body" style="padding: 0 8px">
                    <ul id="demo2"></ul>
                </div>
            </div>
        </div>
        <div class="layui-col-md12" style="height: 45%;overflow-y:auto;">
            <div class="layui-card">
                <div class="layui-card-header card">测试点:</div>
                <div class="layui-card-body" style="padding: 0 8px">
                    <ul id="demo3"></ul>
                </div>
            </div>
        </div>
        <div class="layui-col-md12" style="height: 10%;overflow-y:auto;">
            <button type="button" class="layui-btn" id="downloadlog" style="width: inherit">
                <i class="layui-icon">&#xe601;</i> 下载完整日志
            </button>
        </div>
    </div>
    <div id='debuginfo' class="layui-col-md8" style="height:100%;overflow-y:auto;">
        <div class="layui-card-body">
            <div id="log_text"></div>
        </div>
    </div>
</div>

<div id='gl'>
    <table id='editcfg' lay-filter='editcfg'></table>
    <p style="color:red;margin-left:10px;">勾选和未勾选节点间存在主从关系,主节点(子节点)修改会影响相应从节点(子节点)数据;全部勾选表示平级关系,相互影响  </p>
</div>

<div id='grabview'>a.fdafdafda</div>


<script src="{% static 'manager/layui/layui.js' %}"></script>
<script src="{% static 'manager/js/jquery.min.js' %}"></script>
<script src="{% static 'manager/js/utils.js' %}"></script>
<script src="{% static 'manager/ztree/jquery.ztree.all.min.js' %}"></script>
<!-- <script src="{% static 'manager/ztree/jquery.ztree.core.min.js' %}"></script> -->
<script src="{% static 'manager/ztree/jquery.ztree.core.js' %}"></script>
<script src="{% static 'manager/ztree/jquery.ztree.excheck.min.js' %}"></script>
<script src="{% static 'manager/ztree/jquery.ztree.exedit.js' %}"></script>
<script src="{% static 'manager/js/mytree_1.js' %}"></script>


<script type="text/javascript">
    tree.init();

    $('#searchbtn').click(function (argument) {
        tree.init($('#search').val())
    });

    window.onload = function () {
        document.documentElement.style.overflow = 'hidden';
    };

    layui.use(['element','layer','table'],function(){
        var element = layui.element;
        var table=layui.table;
        $('#start-record').click(function(e){

            layer.msg('开始录制..')
            record_page='http://'+host+'/manager/grab/'
            window.open(record_page,'_blank')



        });


        treeobj=$.fn.zTree.getZTreeObj('case-manager')
        document.onkeydown = function()  
        {  
            selectnodes=treeobj.getSelectedNodes()
            var oEvent = window.event;  

            if (oEvent.keyCode ==81 && oEvent.ctrlKey&&selectnodes.length>1) {  
                // alert(JSON.stringify(selectnodes));  
                editcfgtable=table.render({
                    elem:'#editcfg',
                    cols:[[
                    {type:'checkbox',fixed:'left',title:'主'},
                    {field:'name',title:'节点名称',width:240},
                    {field:'planname',title:'所属计划',width:240}
                    ]],
                    data:add_plan_attribute(treeobj.getSelectedNodes())
                });

                layer.open({
                    title:'修改关联配置',
                    btn:['提交','取消'],
                    type:1,
                    content:$('#gl'),
                    area : [ '600px', '500px' ],
                    yes:function(index,layero){
                        
                        success=function(data){
                            layer.close(index)
                            if(data['code']==0){
                                layer.alert('关联成功',{icon:1})

                            }
                            else{
                                layer.alert('关联异常',{icon:2})
                            }
  

                        }
                        checkidslist=[]
                        checkeddata=table.checkStatus('editcfg').data
        

                        for(var i=0;i<checkeddata.length;i++){
                            checkidslist.splice(-1,0,checkeddata[i]['id'])
                        }
                        _post('/manager/addeditlink/',{'datad':JSON.stringify(treeobj.getSelectedNodes()),'checkids':JSON.stringify(checkidslist)},success)

                    }
                })
            }  
        }



   

    })


function get_plan_name(curnode){

    for (var i=0;i<5;i++){
        p=curnode.getParentNode()
        if('plan'==p.type)
            return p.name

    }
    return '未知'



}

function add_plan_attribute(data){
    for(var i=0;i<data.length;i++){
        treeobj=$.fn.zTree.getZTreeObj('case-manager')
        curnode=treeobj.getNodeByParam('id',data[i]['id'])
        data[i]['planname']=get_plan_name(curnode)

    }
    return data

}





</script>
<script type="text/html" id="toolbar">
    <input type="checkbox" name="status" lay-skin="switch" lay-text="ON|OFF" checked>

</script>
</body>
</html>